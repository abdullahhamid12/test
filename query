select b.accounting_period, b.business_unit, b.currency_cd, null as vendor_name, null as vendor_id, b.fiscal_year,
       b.journal_date, a.journal_id, a.project_id, null as expense_report_id, null as expense_report_title, b.oprid, a.ledger,
       a.journal_line as line_num, a.line_descr, b.source, null as po_id, null as invoice_id, null as voucher_id, a.account, gl.gl_acct_desc,
       a.deptid, di.did_desc, null as employee_name, a.monetary_amount, b.dttm_stamp_sec,
       case when b.journal_date between trunc(trunc(current_date, 'MONTH') - 1, 'MONTH') and trunc(current_date, 'MONTH') - 1 then 'Prev' else 'Curr' end as Vers
from ps_jrnl_ln a
join ps_jrnl_header b on b.business_unit = a.business_unit and b.journal_date = a.journal_date and b.journal_id = a.journal_id and b.unpost_seq = a.unpost_seq
left outer join (select account, descr as gl_acct_desc, effdt, row_number() over (partition by account order by effdt desc) as rnk from ps_gl_account_tbl a) gl on gl.account = a.account and gl.rnk = 1
left outer join (select deptid, descr as did_desc, effdt, row_number() over (partition by deptid order by effdt desc) as rnk from ps_dept_tbl a) di on di.deptid = a.deptid and di.rnk = 1
where a.journal_date >= to_date('&dt_str', 'YYYY-MM-DD')
and b.jrnl_hdr_status in ('U', 'P')
and a.account like '8%'
and b.source not in ('EX', 'AP')
and a.ledger in ('CORP', 'LOCAL')
union all
select a.accounting_period, a.business_unit_gl, a.currency_cd, null as vendor_name, null as vendor_id, a.fiscal_year, a.journal_date,
       a.journal_id, a.project_id, b.sheet_id as expense_report_id, c.sheet_name as expense_report_title, c.oprid_entered_by as oprid, null as ledger,
       a.line_nbr as line_num, b.descr254 as line_desc, 'EX' as source, null as po_id, null as invoice_id, null as voucher_id, a.account, gl.gl_acct_desc,
       a.deptid, di.did_desc, e.name as employee_name, a.monetary_amount, c.date_time_hm as ddtm_stamp_sec,
       case when a.journal_date between trunc(trunc(current_date, 'MONTH') - 1, 'MONTH') and trunc(current_date, 'MONTH') - 1 then 'Prev' else 'Curr' end as Vers
from ps_ex_acctg_line a
join ps_ex_sheet_line b on a.line_nbr = b.line_nbr and a.ex_doc_id = b.sheet_id
left outer join (select account, descr as gl_acct_desc, effdt, row_number() over (partition by account order by effdt desc) as rnk from ps_gl_account_tbl a) gl on gl.account = a.account and gl.rnk = 1
left outer join (select deptid, descr as did_desc, effdt, row_number() over (partition by deptid order by effdt desc) as rnk from ps_dept_tbl a) di on di.deptid = a.dept
