SELECT
    a.accounting_period,
    a.business_unit_gl,
    a.currency_cd,
    NULL AS vendor_name,
    NULL AS vendor_id,
    a.fiscal_year,
    a.journal_date,
    a.journal_id,
    a.project_id,
    b.sheet_id AS expense_report_id,
    c.sheet_name AS expense_report_title,
    c.oprid_entered_by AS oprid,
    NULL AS ledger,
    a.line_nbr AS line_num,
    b.descr254 AS line_desc,
    'EX' AS source,
    NULL AS po_id,
    NULL AS invoice_id,
    NULL AS voucher_id,
    a.account,
    gl.gl_acct_desc,
    a.deptid,
    di.did_desc,
    e.name AS employee_name,
    a.monetary_amount,
    c.date_time_hm AS ddtm_stamp_sec,
    CASE
        WHEN a.journal_date BETWEEN DATE_FORMAT(DATE_FORMAT(CURRENT_DATE, '%Y-%M-01'), '%Y-%M-%D') AND DATE_FORMAT(DATE_SUB(DATE_FORMAT(CURRENT_DATE, '%Y-%M-01'), INTERVAL 1 DAY), '%Y-%M-%D')
            THEN 'Prev'
        ELSE 'Curr'
    END AS Vers
FROM
    ps_ex_acctg_line a
    INNER JOIN ps_ex_sheet_line b ON a.line_nbr = b.line_nbr AND a.ex_doc_id = b.sheet_id
    LEFT JOIN (
        SELECT
            account,
            descr AS gl_acct_desc,
            effdt
        FROM
            ps_gl_account_tbl a
        WHERE
            (account, effdt) IN (
                SELECT
                    account,
                    MAX(effdt)
                FROM
                    ps_gl_account_tbl
                GROUP BY
                    account
            )
    ) gl ON gl.account = a.account
    LEFT JOIN (
        SELECT
            deptid,
            descr AS did_desc,
            effdt
        FROM
            ps_dept_tbl a
        WHERE
            (deptid, effdt) IN (
                SELECT
                    deptid,
                    MAX(effdt)
                FROM
                    ps_dept_tbl
                GROUP BY
                    deptid
            )
    ) di ON di.deptid = a.deptid
    INNER JOIN ps_ex_sheet_hdr c ON a.ex_doc_id = c.sheet_id
    INNER JOIN ps_personal_data e ON c.emplid = e.emplid
    LEFT JOIN ps_c1_te_ex_shtatt f ON a.ex_doc_id = f.sheet_id AND a.line_nbr = f.line_nbr
WHERE
    a.journal_date >= """ + dt_str + """
    AND a.gl_distrib_status = 'D'
    AND a.account LIKE '8%'
