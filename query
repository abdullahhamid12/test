SELECT 
    A.ACCOUNTING_PERIOD, A.BUSINESS_UNIT_GL, A.CURRENCY_CD, NULL AS VENDOR_NAME, NULL AS VENDOR_ID, A.FISCAL_YEAR, A.JOURNAL_DATE,
    A.JOURNAL_ID, A.PROJECT_ID, B.SHEET_ID AS EXPENSE_REPORT_ID, C.SHEET_NAME AS EXPENSE_REPORT_TITLE,
    C.OPRID_ENTERED_BY AS OPRID, NULL AS LEDGER, A.LINE_NBR AS LINE_NUM, B.DESCR254 AS LINE_DESC, 'EX' AS SOURCE,
    NULL AS PO_ID, NULL AS INVOICE_ID, NULL AS VOUCHER_ID, A.ACCOUNT, GL.GL_ACCT_DESC, A.DEPTID, DI.DID_DESC,
    E.NAME AS EMPLOYEE_NAME, A.MONETARY_AMOUNT, C.DATE_TIME_HM AS DDTM_STAMP_SEC,
    CASE 
        WHEN A.JOURNAL_DATE BETWEEN DATE_FORMAT(DATE_FORMAT(CURRENT_DATE, '%Y-%M-01'), '%Y-%M-%D') AND DATE_FORMAT(DATE_SUB(DATE_FORMAT(CURRENT_DATE, '%Y-%M-01'), INTERVAL 1 DAY), '%Y-%M-%D')
            THEN 'PREV' 
        ELSE 'CURR' 
    END AS VERS
FROM 
    PS_EX_ACCTG_LINE A
JOIN 
    PS_EX_SHEET_LINE B ON A.LINE_NBR = B.LINE_NBR AND A.EX_DOC_ID = B.SHEET_ID
LEFT OUTER JOIN 
    (SELECT ACCOUNT, MAX(EFFDT) AS MAX_EFFDT
    FROM PS_GL_ACCOUNT_TBL
    GROUP BY ACCOUNT) AS GL_MAX ON A.ACCOUNT = GL_MAX.ACCOUNT
LEFT OUTER JOIN 
    PS_GL_ACCOUNT_TBL GL ON A.ACCOUNT = GL.ACCOUNT AND GL.EFFDT = GL_MAX.MAX_EFFDT
LEFT OUTER JOIN 
    (SELECT DEPTID, MAX(EFFDT) AS MAX_EFFDT
    FROM PS_DEPT_TBL
    GROUP BY DEPTID) AS DI_MAX ON A.DEPTID = DI_MAX.DEPTID
LEFT OUTER JOIN 
    PS_DEPT_TBL DI ON A.DEPTID = DI.DEPTID AND DI.EFFDT = DI_MAX.MAX_EFFDT
JOIN 
    PS_EX_SHEET_HDR C ON A.EX_DOC_ID = C.SHEET_ID
JOIN 
    PS_PERSONAL_DATA E ON C.EMPLID = E.EMPLID
WHERE 
    A.JOURNAL_DATE >= '2022-01-01'
    AND A.GL_DISTRIB_STATUS = 'D'
    AND A.ACCOUNT LIKE '8%';
