SELECT b.accounting_period,b.business_unit,b.currency_cd,NULL AS vendor_name,NULL AS vendor_id,b.fiscal_year,
       b.journal_date,a.journal_id,a.project_id,
       NULL AS expense_report_id,NULL AS expense_report_title,b.oprid,a.ledger,a.journal_line AS line_num,a.line_descr,b.source,
       NULL AS po_id, NULL AS invoice_id ,NULL AS voucher_id,a.account,gl.gl_acct_desc,a.deptid,di.did_desc, NULL AS employee_name,
       a.monetary_amount,
       b.dttm_stamp_sec,
       CASE 
         WHEN b.journal_date BETWEEN TRUNC(TRUNC(CURRENT_DATE, 'MONTH')-1, 'MONTH') AND TRUNC(CURRENT_DATE, 'MONTH')-1
         THEN 'Prev' ELSE 'Curr' 
       END AS Vers
FROM ps_jrnl_ln  a
JOIN ps_jrnl_header b
  ON b.business_unit=a.business_unit
 AND b.journal_date=a.journal_date
 AND b.journal_id=a.journal_id
 AND b.unpost_seq=a.unpost_seq
LEFT OUTER JOIN 
  (SELECT account, descr AS gl_acct_desc, effdt, row_number() OVER (PARTITION BY account ORDER BY effdt DESC) AS rnk
   FROM ps_gl_account_tbl a) gl
  ON gl.account = a.account
 AND gl.rnk = 1
LEFT OUTER JOIN 
  (SELECT deptid, descr AS did_desc, effdt, row_number() OVER (PARTITION BY deptid ORDER BY effdt DESC) AS rnk
   FROM ps_dept_tbl a) di
  ON di.deptid = a.deptid
 AND di.rnk = 1
WHERE a.journal_date >= TO_DATE('&dt_str', 'YYYY-MM-DD')
  AND b.jrnl_hdr_status IN ('U','P')
  AND a.account LIKE '8%'
  AND b.source NOT IN ('EX','AP')
  AND a.ledger IN ('CORP', 'LOCAL')
UNION ALL
SELECT a.accounting_period,a.business_unit_gl,a.currency_cd,NULL AS vendor_name,NULL AS vendor_id,a.fiscal_year,a.journal_date,
       a.journal_id,a.project_id, b.sheet_id AS expense_report_id,c.sheet_name AS expense_report_title,
       c.oprid_entered_by AS oprid,NULL AS ledger,a.line_nbr AS line_num, b.descr254 AS line_desc,'EX' AS source,
       NULL AS po_id, NULL AS invoice_id ,NULL AS voucher_id,a.account,gl.gl_acct_desc,a.deptid,di.did_desc,
       e.name AS employee_name,a.monetary_amount, c.date_time_hm AS ddtm_stamp_sec,
       CASE 
         WHEN a.journal_date BETWEEN TRUNC(TRUNC(CURRENT_DATE, 'MONTH')-1, 'MONTH') AND TRUNC(CURRENT_DATE, 'MONTH')-1
         THEN 'Prev' ELSE 'Curr' 
       END AS Vers
FROM ps_ex_acctg_line  a
JOIN ps_ex_sheet_line b
  ON a.line_nbr=b.line_nbr
 AND a.ex_doc_id=b.sheet_id
LEFT OUTER JOIN 
  (SELECT account, descr AS gl_acct_desc, effdt, row_number() OVER (PARTITION BY account ORDER BY effdt DESC) AS rnk
   FROM ps_gl_account_tbl a) gl
  ON gl.account = a.account
 AND gl.rnk = 1
LEFT OUTER JOIN 
  (SELECT deptid, descr AS did_desc, effdt,
         row_number() OVER (PARTITION BY deptid ORDER BY eff
